# UGTF CI/CD Pipeline for storeFront
# FIX: Uses Buildpacks (No Dockerfile)
name: StoreFront CI/CD to Cloud Run

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_ID: top-cedar-471512-k3
  PROJECT_NUMBER: 30228073381
  REGION: us-east1
  SERVICE_NAME: storefront
  ARTIFACT_REPO: storeapi
  IMAGE_NAME: storefront2
  SERVICE_URL: https://storefront-30228073381.us-east1.run.app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/ugtf-github-pool/providers/github-actions
          service_account: github-runner-ugtf@${{ env.PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # üî¥ OLD STEP REMOVED: docker build ...
      # üü¢ NEW STEP ADDED: Build with Buildpacks
      - name: Build with Cloud Buildpacks
        id: build
        run: |
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          
          echo "Building with Buildpacks: $IMAGE_TAG"
          
          # This command builds the image securely on Google Cloud (not the runner)
          # It mimics exactly what happens when you deploy from the console
          gcloud builds submit --pack image="$IMAGE_TAG" .
          
          echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ steps.build.outputs.image }}
          wait: true
          flags: '--allow-unauthenticated'
          env_vars: |
            ALLOWED_HOSTS=${{ env.SERVICE_URL }}
            SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}

  # 2Ô∏è‚É£ Health Check (Standard)
  health-check:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    steps:
      - name: Verify Cloud Run deployment health
        run: |
          echo "Checking service health at ${{ env.SERVICE_URL }}..."
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.SERVICE_URL }})
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Health check passed (HTTP 200)"
              exit 0
            fi
            echo "Waiting for service... (status $STATUS)"
            sleep 5
          done
          echo "‚ùå Service did not become healthy in time."
          exit 1